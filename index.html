<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>vgmstream-web Player</title>
<meta name="viewport" content="width=device-width">
<meta name="description" content="Listen to streamed video game audio files in your browser">
<meta name="color-scheme" content="light dark">
<meta name="theme-color" content="#5b9d2f">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="img/favicon.png" type="image/png">
<link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
<link rel="stylesheet" href="css/player.css">
<link rel="stylesheet" href="css/player-dark.css" media="(prefers-color-scheme: dark)">
<script src="js/dark-toggle.js"></script>
</head>
<body>
<main>
	<header><h2>vgmstream-web</h2></header>
	<input type="file" multiple id="browse">
	<input type="file" webkitdirectory id="browsedir">
	<div id="buttons" data-nosnippet>
		<button class="greenbutton" id="selectbtn">Select or drop an audio stream file here...</button>
		<button class="greenbutton" id="selectdirbtn">Folder</button>
	</div>
	<noscript><div data-nosnippet>This page requires JavaScript to be enabled in your browser.</div></noscript>
	<div id="wasmwarning" data-nosnippet>This page requires WebAssembly to be enabled in your browser.</div>
	<div id="directorybox">
		<form>
			<select id="dirselect" size="2"></select>
			<div><input id="dirselectbtn" class="button" type="submit" value="Select"></div>
		</form>
	</div>
	<div id="audiobox">
		<div id="filenamebox"></div>
		<div><custom-audio id="audio" controls></custom-audio></div>
		<div><input id="download" class="button" type="button" value="Download"></div>
		<div id="logbox">
			<a id="logdropdown" tabindex="0">vgmstream output</a>
			<div id="log"></div>
		</div>
	</div>
</main>
<div id="footer" data-nosnippet>
	<ul>
		<li><a href="https://github.com/vgmstream/vgmstream">vgmstream</a></li>
		<li><a href="https://github.com/KatieFrogs">Katie Frogs</a></li>
		<li>
			<a id="darktoggle" tabindex="0">Dark theme</a>
			<a id="darkreset" tabindex="0" title="Reset">(x)</a>
		</li>
	</ul>
</footer>
<div id="fadeoverlay" data-nosnippet>...</div>
<script src="js/soundbuffer.js"></script>
<script src="js/custom-audio.js"></script>
<script src="js/player.js"></script>
<script>
async function displayFiles(files) {
    for (const file of files) {
        console.log("ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«è§£æé–‹å§‹:", file.name);

        // 1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Workerã®ä»®æƒ³ãƒ¡ãƒ¢ãƒªã«ã—ã£ã‹ã‚Šæ›¸ãè¾¼ã‚€
        const arrayBuffer = await file.arrayBuffer();
        await cliWorker.send("writeFile", file.name, new Uint8Array(arrayBuffer));

        // 2. vgmstreamã«ã€Œæƒ…å ±ã ã‘å‡ºã—ã¦ã€ã¨å‘½ä»¤ï¼ˆ-m ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        // ã“ã“ã§ã—ã£ã‹ã‚Š await ã—ã¦è§£æå®Œäº†ã‚’å¾…ã¤
        const info = await cliWorker.send("vgmstream", "-m", "-i", file.name);
        
        // 3. ãƒ­ã‚°ï¼ˆstdoutï¼‰ã‹ã‚‰ã‚¹ãƒˆãƒªãƒ¼ãƒ æ•°ã‚’æ¢ã—å‡ºã™
        // ã€ŒStream index: 0 / 10ã€ã®ã‚ˆã†ãªæ–‡å­—åˆ—ã‚’æ¢ã™æ­£è¦è¡¨ç¾
        const streamMatch = info.stdout.match(/Stream index: \d+ \/ (\d+)/);
        let totalStreams = streamMatch ? parseInt(streamMatch[1]) : 1;

        // ã€ç·Šæ€¥å¯¾ç­–ã€‘ã‚‚ã—æ­£è¦è¡¨ç¾ã§å–ã‚Œãªãã¦ã‚‚ã€ãƒ­ã‚°ã«ã€ŒStreams: 10ã€ãªã©ãŒã‚ã‚Œã°ãã‚Œã‚’å–ã‚‹
        if (totalStreams === 1) {
            const altMatch = info.stdout.match(/Streams: (\d+)/i);
            if (altMatch) totalStreams = parseInt(altMatch[1]);
        }

        console.log(`âœ… åˆè¨ˆ ${totalStreams} å€‹ã®éŸ³å£°ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚`);

        // 4. ãƒ«ãƒ¼ãƒ—ã§1ã¤ãšã¤æ•‘å‡º
        for (let i = 1; i <= totalStreams; i++) {
            console.log(`ğŸ§ ã‚¹ãƒˆãƒªãƒ¼ãƒ  ${i} / ${totalStreams} ã‚’å¤‰æ›ä¸­...`);
            
            const outName = `output_${i}.wav`;
            // "-s ç•ªå·" ã§ç¢ºå®Ÿã«æŒ‡å®š
            await cliWorker.send("vgmstream", "-s", i.toString(), "-i", file.name, "-o", outName);
            
            const wavData = await cliWorker.send("readFile", outName);
            if (wavData) {
                const url = URL.createObjectURL(new Blob([wavData], { type: "audio/wav" }));
                const link = document.createElement("a");
                link.href = url;
                link.download = `${file.name}_stream${i}.wav`;
                link.click();
                await new Promise(r => setTimeout(r, 500)); // ãƒ–ãƒ©ã‚¦ã‚¶ã®DLè©°ã¾ã‚Šé˜²æ­¢
            }
            await cliWorker.send("deleteFile", outName);
        }
        await cliWorker.send("deleteFile", file.name);
    }
    console.log("âœ… å…¨è¡Œç¨‹çµ‚äº†ï¼");
}
</script>
</body>
</html>
