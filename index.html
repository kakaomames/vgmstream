<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>vgmstream-web Player</title>
<meta name="viewport" content="width=device-width">
<meta name="description" content="Listen to streamed video game audio files in your browser">
<meta name="color-scheme" content="light dark">
<meta name="theme-color" content="#5b9d2f">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="img/favicon.png" type="image/png">
<link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
<link rel="stylesheet" href="css/player.css">
<link rel="stylesheet" href="css/player-dark.css" media="(prefers-color-scheme: dark)">
<script src="js/dark-toggle.js"></script>
</head>
<body>
<main>
	<header><h2>vgmstream-web</h2></header>
	<input type="file" multiple id="browse">
	<input type="file" webkitdirectory id="browsedir">
	<div id="buttons" data-nosnippet>
		<button class="greenbutton" id="selectbtn">Select or drop an audio stream file here...</button>
		<button class="greenbutton" id="selectdirbtn">Folder</button>
	</div>
	<noscript><div data-nosnippet>This page requires JavaScript to be enabled in your browser.</div></noscript>
	<div id="wasmwarning" data-nosnippet>This page requires WebAssembly to be enabled in your browser.</div>
	<div id="directorybox">
		<form>
			<select id="dirselect" size="2"></select>
			<div><input id="dirselectbtn" class="button" type="submit" value="Select"></div>
		</form>
	</div>
	<div id="audiobox">
		<div id="filenamebox"></div>
		<div><custom-audio id="audio" controls></custom-audio></div>
		<div><input id="download" class="button" type="button" value="Download"></div>
		<div id="logbox">
			<a id="logdropdown" tabindex="0">vgmstream output</a>
			<div id="log"></div>
		</div>
	</div>
</main>
<div id="footer" data-nosnippet>
	<ul>
		<li><a href="https://github.com/vgmstream/vgmstream">vgmstream</a></li>
		<li><a href="https://github.com/KatieFrogs">Katie Frogs</a></li>
		<li>
			<a id="darktoggle" tabindex="0">Dark theme</a>
			<a id="darkreset" tabindex="0" title="Reset">(x)</a>
		</li>
	</ul>
</footer>
<div id="fadeoverlay" data-nosnippet>...</div>
<script src="js/soundbuffer.js"></script>
<script src="js/custom-audio.js"></script>
<script src="js/player.js"></script>
<script>
	<script>
  // 隊長考案：既存の機能をジャックする最小限コード
  var blobWarehouse = []; // Blobを消さないための倉庫

  // 元の displayFiles を上書き（ジャック）する
  async function displayFiles(files) {
    for (const file of files) {
      console.log("処理開始: " + file.name);
      
      // 1. Workerに変換を依頼（元のコードの関数を呼び出す）
      const response = await convertFile(file);
      
      // 2. 倉庫に保存してBlobリンクが消えるのを防ぐ
      blobWarehouse.push(response.url);
      
      // 3. 画面のプレイヤーとファイル名をセット
      audio.src = response.url;
      dlfilename = response.outputFilename;
      
      // 4. 元からあるダウンロードボタンを自動で「ポチッ」と押す
      download.click();
      
      // 5. ブラウザがDL処理をさばくための休憩時間
      await new Promise(r => setTimeout(r, 800));
    }
    alert("全ファイルの変換とダウンロード指示が完了しました！");
  }
</script>
</script>
</body>
</html>
