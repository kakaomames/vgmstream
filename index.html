<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>vgmstream-web Player</title>
<meta name="viewport" content="width=device-width">
<meta name="description" content="Listen to streamed video game audio files in your browser">
<meta name="color-scheme" content="light dark">
<meta name="theme-color" content="#5b9d2f">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="img/favicon.png" type="image/png">
<link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
<link rel="stylesheet" href="css/player.css">
<link rel="stylesheet" href="css/player-dark.css" media="(prefers-color-scheme: dark)">
<script src="js/dark-toggle.js"></script>
</head>
<body>
<main>
	<header><h2>vgmstream-web</h2></header>
	<input type="file" multiple id="browse">
	<input type="file" webkitdirectory id="browsedir">
	<div id="buttons" data-nosnippet>
		<button class="greenbutton" id="selectbtn">Select or drop an audio stream file here...</button>
		<button class="greenbutton" id="selectdirbtn">Folder</button>
	</div>
	<noscript><div data-nosnippet>This page requires JavaScript to be enabled in your browser.</div></noscript>
	<div id="wasmwarning" data-nosnippet>This page requires WebAssembly to be enabled in your browser.</div>
	<div id="directorybox">
		<form>
			<select id="dirselect" size="2"></select>
			<div><input id="dirselectbtn" class="button" type="submit" value="Select"></div>
		</form>
	</div>
	<div id="audiobox">
		<div id="filenamebox"></div>
		<div><custom-audio id="audio" controls></custom-audio></div>
		<div><input id="download" class="button" type="button" value="Download"></div>
		<div id="logbox">
			<a id="logdropdown" tabindex="0">vgmstream output</a>
			<div id="log"></div>
		</div>
	</div>
</main>
<div id="footer" data-nosnippet>
	<ul>
		<li><a href="https://github.com/vgmstream/vgmstream">vgmstream</a></li>
		<li><a href="https://github.com/KatieFrogs">Katie Frogs</a></li>
		<li>
			<a id="darktoggle" tabindex="0">Dark theme</a>
			<a id="darkreset" tabindex="0" title="Reset">(x)</a>
		</li>
	</ul>
</footer>
<div id="fadeoverlay" data-nosnippet>...</div>
<script src="js/soundbuffer.js"></script>
<script src="js/custom-audio.js"></script>
<script src="js/player.js"></script>
<script>
	<script>
  // 隊長考案：既存の機能をジャックする最小限コード
  var blobWarehouse = []; // Blobを消さないための倉庫

  // 元の displayFiles を上書き（ジャック）する
async function displayFiles(files) {
    for (const file of files) {
        // 1. まず1番目を変換して、全部で何個ストリームがあるか確認する
        let response = await convertFile(file);
        
        // ログから「全ストリーム数」を取得（例: "0 / 10" から "10" を探す）
        const totalStreamsMatch = response.stdout.match(/Stream index: \d+ \/ (\d+)/);
        const totalStreams = totalStreamsMatch ? parseInt(totalStreamsMatch[1]) : 1;

        console.log(`このファイルには ${totalStreams} 個の音が含まれています。`);

        // 2. ストリームの数だけループして変換・DLする
        for (let s = 1; s <= totalStreams; s++) {
            console.log(`ストリーム ${s} を処理中...`);
            
            // vgmstreamに関数 "-s 番号" を渡して、特定の音を取り出す
            // ※既存の convertFile が引数を受け取れるよう、vgmstream を直接叩くイメージ
            const streamResponse = await cliWorker.send("vgmstream", "-s", s.toString(), "-i", file.name, "-o", "out.wav");
            
            // 変換後のデータを取得してDL
            const wavData = await readFile("out.wav");
            const url = URL.createObjectURL(new Blob([wavData], { type: "audio/x-wav" }));
            
            const link = document.createElement("a");
            link.href = url;
            link.download = `${file.name}_${s}.wav`;
            link.click();
            
            // メモリ解放を防ぐために一瞬待機
            await new Promise(r => setTimeout(r, 500));
        }
    }
}
</script>
</body>
</html>
