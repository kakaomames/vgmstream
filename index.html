<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>vgmstream-web Player</title>
<meta name="viewport" content="width=device-width">
<meta name="description" content="Listen to streamed video game audio files in your browser">
<meta name="color-scheme" content="light dark">
<meta name="theme-color" content="#5b9d2f">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="img/favicon.png" type="image/png">
<link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
<link rel="stylesheet" href="css/player.css">
<link rel="stylesheet" href="css/player-dark.css" media="(prefers-color-scheme: dark)">
<script src="js/dark-toggle.js"></script>
</head>
<body>
<main>
	<header><h2>vgmstream-web</h2></header>
	<input type="file" multiple id="browse">
	<input type="file" webkitdirectory id="browsedir">
	<div id="buttons" data-nosnippet>
		<button class="greenbutton" id="selectbtn">Select or drop an audio stream file here...</button>
		<button class="greenbutton" id="selectdirbtn">Folder</button>
	</div>
	<noscript><div data-nosnippet>This page requires JavaScript to be enabled in your browser.</div></noscript>
	<div id="wasmwarning" data-nosnippet>This page requires WebAssembly to be enabled in your browser.</div>
	<div id="directorybox">
		<form>
			<select id="dirselect" size="2"></select>
			<div><input id="dirselectbtn" class="button" type="submit" value="Select"></div>
		</form>
	</div>
	<div id="audiobox">
		<div id="filenamebox"></div>
		<div><custom-audio id="audio" controls></custom-audio></div>
		<div><input id="download" class="button" type="button" value="Download"></div>
		<div id="logbox">
			<a id="logdropdown" tabindex="0">vgmstream output</a>
			<div id="log"></div>
		</div>
	</div>
</main>
<div id="footer" data-nosnippet>
	<ul>
		<li><a href="https://github.com/vgmstream/vgmstream">vgmstream</a></li>
		<li><a href="https://github.com/KatieFrogs">Katie Frogs</a></li>
		<li>
			<a id="darktoggle" tabindex="0">Dark theme</a>
			<a id="darkreset" tabindex="0" title="Reset">(x)</a>
		</li>
	</ul>
</footer>
<div id="fadeoverlay" data-nosnippet>...</div>
<script src="js/soundbuffer.js"></script>
<script src="js/custom-audio.js"></script>
<script src="js/player.js"></script>
<script>
// éšŠé•·ã‹ã‚‰ã®ç·Šæ€¥ãƒ‘ãƒƒãƒï¼šãƒãƒ«ãƒã‚¹ãƒˆãƒªãƒ¼ãƒ å…¨æ•‘å‡ºã‚³ãƒ¼ãƒ‰
async function displayFiles(files) {
    for (const file of files) {
        console.log("ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«è§£æé–‹å§‹:", file.name);

        // 1. ä»®æƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«æ›¸ãè¾¼ã‚€
        const arrayBuffer = await file.arrayBuffer();
        await cliWorker.send("writeFile", file.name, new Uint8Array(arrayBuffer));

        // 2. ã¾ãšæƒ…å ±ã‚’å–å¾—ã—ã¦ã€å…¨éƒ¨ã§ä½•å€‹å…¥ã£ã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹
        const info = await cliWorker.send("vgmstream", "-m", "-i", file.name);
        
        // ãƒ­ã‚°ã‹ã‚‰ 0 / 10 ã®ã€Œ10ã€ã‚’æŠ½å‡º
        const match = info.stdout.match(/Stream index: \d+ \/ (\d+)/);
        const totalStreams = match ? parseInt(match[1]) : 1;
        
        console.log(`âœ… åˆè¨ˆ ${totalStreams} å€‹ã®éŸ³å£°ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚`);

        // 3. 1ã¤ãšã¤ç•ªå·ã‚’æŒ‡å®šã—ã¦å¤‰æ›ãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        for (let i = 1; i <= totalStreams; i++) {
            console.log(`ğŸ§ ã‚¹ãƒˆãƒªãƒ¼ãƒ  ${i} ã‚’å¤‰æ›ä¸­...`);
            
            const outName = `stream_${i}.wav`;
            // "-s ç•ªå·" ã§ç‰¹å®šã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’æŒ‡å®šã™ã‚‹ã®ãŒã‚³ãƒ„ï¼
            const res = await cliWorker.send("vgmstream", "-s", i.toString(), "-i", file.name, "-o", outName);
            
            // å¤‰æ›ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
            const wavData = await cliWorker.send("readFile", outName);
            
            if (wavData) {
                const blob = new Blob([wavData], { type: "audio/wav" });
                const url = URL.createObjectURL(blob);
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
                const link = document.createElement("a");
                link.href = url;
                link.download = `${file.name}_${i}.wav`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // ãƒ–ãƒ©ã‚¦ã‚¶ãŒãƒ‘ãƒ³ã‚¯ã—ãªã„ã‚ˆã†ã«å°‘ã—å¾…æ©Ÿ
                await new Promise(r => setTimeout(r, 300));
            }
            
            // ä»®æƒ³ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ã‚´ãƒŸæƒé™¤
            await cliWorker.send("deleteFile", outName);
        }
        
        // æœ€å¾Œã«å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å‰Šé™¤
        await cliWorker.send("deleteFile", file.name);
    }
    alert("å…¨ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®æ•‘å‡ºä»»å‹™ã€å®Œäº†ã—ã¾ã—ãŸï¼");
}
</script>
</body>
</html>
