name: Transpile SO to WASM

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  transpile:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ LLVMãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt update
          sudo apt install -y llvm clang
          echo "llvm_installed: true"

      - name: ğŸ—ï¸ Emscripten SDK (emsdk) ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        run: |
          git clone https://github.com/emscripten-core/emsdk.git
          cd emsdk
          ./emsdk install latest
          ./emsdk activate latest
          echo "emsdk_setup: complete"

      - name: ğŸ” ãƒ“ãƒƒãƒˆã‚³ãƒ¼ãƒ‰ã®æŠ½å‡º (.so -> .bc)
        run: |
          # libãƒ•ã‚©ãƒ«ãƒ€å†…ã®.soãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¯¾è±¡ã«ã™ã‚‹
          SO_FILE=$(ls lib/*.so | head -n 1)
          echo "target_so:${SO_FILE}"
          
          # ãƒ“ãƒƒãƒˆã‚³ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠœãå‡ºã™ï¼
          llvm-objcopy --dump-section .llvmbc=extracted.bc $SO_FILE || echo "Warning: Section .llvmbc not found, trying direct use"
          
          # ã‚‚ã—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒãªã‘ã‚Œã°ã€.soè‡ªä½“ãŒãƒ“ãƒƒãƒˆã‚³ãƒ¼ãƒ‰ã®å¯èƒ½æ€§ã‚‚ã‚ã‚‹ã®ã§ã‚³ãƒ”ãƒ¼
          if [ ! -f extracted.bc ]; then cp $SO_FILE extracted.bc; fi
          echo "extracted_bc_size:$(du -h extracted.bc)"

      - name: âš™ï¸ Emscriptenã§WASMã«ç¿»è¨³
        run: |
          source ./emsdk/emsdk_env.sh
          
          # ç¿»è¨³é–‹å§‹ï¼
          emcc extracted.bc -o converted_library.js \
            -O3 \
            -s WASM=1 \
            -s ALLOW_MEMORY_GROWTH=1 \
            -s EXPORTED_RUNTIME_METHODS='["FS", "callMain", "stringToUTF8", "UTF8ToString"]' \
            -s MODULARIZE=1 \
            -s EXPORT_NAME='MyCustomModule' \
            -s EXIT_RUNTIME=1 \
            --no-entry
          
          echo "transpile_status: SUCCESS"

      - name: ğŸ“¤ æˆæœç‰©(WASM/JS)ã‚’ä¿å­˜
        uses: actions/upload-artifact@v4
        with:
          name: wasm-transpiled-lib
          path: |
            converted_library.js
            converted_library.wasm
